<!doctype html>

<html>

<head></head>

<body>

<script>

const params = new URLSearchParams(location.search);

(function (h, w) {

    const
         maybe = (t, s) => (s !== null && typeof s !== 'undefined' || s instanceof t) ? s : t()
        ,find = id => document.getElementById(id)
        ,id = i => {

            let n = '', m;

            while (i) {

                m = (i - 1) % 26;
                n = String.fromCharCode(97 + m) + n;
                i = parseInt((i - m) / 26);
            }

            return n;
        }
        ,i = id => {

            const chars = id.toLowerCase().split('');
            let i = 0;

            for (let j = 0, char;char = chars[j]; j++)
                i += (char.charCodeAt(0) - 97) * Math.pow(26, chars.length - j - 1);

            return i;    
        }
        ,Cell = (value) => {
            const cell = {
                 value: typeof value !== 'undefined' ? value : ''
                ,isExpression: () => cell.value[0] == '='
                ,isError: false
                ,isEmpty: () => cell.value === ''
                ,isFloat: () => /^(\d+\.*)+$/.test(cell.value)
            };
            return cell;
        }
        ,Sheet = (() => {
            
            let _ = {}, self;

            const
                 exists = id => typeof _[id] !== 'undefined'
                ,get = id => exists(id) ? _[id] : null
                ,set = (id, value) => {
                    ('' + value).replace(/\s+/, '') ? _[id] = Cell(value): del(id);
                    return self;
                }
                ,del = id => exists(id) && (delete _[id])
                ,cells = () => _
                ,ids = () => Object.keys(_)
                ,calc = (id) => {

                    if ( ! self.exists(id)) return undefined;
                    
                    let cell = self.get(id);

                    if (cell.isExpression()) {

                        if (cell.value.length == 1)
                            return '=SintaxError';

                        let
                             exp = cell.value.slice(1)
                            ,err = () => cell.isError = true
                            ,f = `try {let r = eval("${exp}"); return r;} catch(ex) {eval("${err()}"); return '=' + ex.name;}`
                        ;

                        const ids = exp.replace(/\s+/, '').split(/[\+\-\*\/]/).reduce((ids, id) => {
                            /^[a-z]+\d+$/i.test(id) && ids.push(id.toLowerCase());
                            return ids;
                        }, []);
                        return (new Function(...ids, f))(...ids.map(id => ({valueOf: () => self.calc(id)}))).valueOf();
                    }
                    else if(cell.isFloat()) {

                        return parseFloat(cell.value);
                    }
                    else if( ! cell.isEmpty()) {

                        return NaN;
                    }
                    else {
                        return cell.value;
                    }
                }
            ;

            return self = {
                 get: get
                ,set: set
                ,del: del
                ,exists: exists
                ,ids: ids
                ,cells: cells
                ,calc: calc
            };
        })()
        ,createTable = (h, w) => {

            let
                dom = document.createDocumentFragment(),
                table = document.createElement('table');
        
            dom.appendChild(table);
        
            for (let y = 0; y < h + 1; y++) {
        
                let row = table.insertRow();
        
                for (let x = 0; x < w + 1; x++)
        
                    row.insertCell().innerHTML = x && y
                        ? `<input id="${id(x)}${y}" />`
                        : y || id(x).toUpperCase();
            }
            
            return dom;
        }
        ,keydown = ev => {

            if (ev.keyCode === 13) {

                const z = ev.target.id.replace(/\d+/, '');
                let x = i(z);
                let y = parseInt(ev.target.id.replace(z, ''));

                if (y < h) {
                    document.getElementById(z + ++y).focus();
                }
                else if (++x < w) {
                    document.getElementById(id(x + 1) + 1).focus();
                }
                else {
                    document.getElementById('a1').focus();
                }
            }
            }
        ,focus = ev => {

            ev.target.value = maybe(Cell, Sheet.get(ev.target.id)).value;
            ev.target.addEventListener('blur', blur, true);
        }
        ,blur = ev => {

            ev.target.removeEventListener('blur', blur);

            if (ev.target.value == Sheet.get(ev.target.id))
                return;
            
            Sheet.set(ev.target.id, ev.target.value);
            Sheet.ids().forEach(id => find(id).value = Sheet.calc(id));
        }
    ;

    document.body.appendChild(createTable(h, w));
    document.addEventListener('focus', focus, true);
    document.addEventListener('keydown', keydown, true);

}(10, 10);

</script>

</body>

</html>
